#ifndef	__TC_SHM_H__
#define __TC_SHM_H__

#include <unistd.h>
#include <sys/types.h>
#include <sys/shm.h>
#include "tc_ex.h"

namespace taf
{
/////////////////////////////////////////////////
/**
 * @file  tc_shm.h
 * @brief å…±äº«å†…å­˜å°è£…ç±» 
 *
 */
/////////////////////////////////////////////////


/**
* @brief å…±äº«å†…å­˜å¼‚å¸¸ç±»
*/
struct TC_Shm_Exception : public TC_Exception
{
    TC_Shm_Exception(const string &buffer) : TC_Exception(buffer){};
    TC_Shm_Exception(const string &buffer, int err) : TC_Exception(buffer, err){};
    ~TC_Shm_Exception() throw() {};
};

/**
* @brief  å…±äº«å†…å­˜è¿æ¥ç±»ï¼Œè¯´æ˜:
* 1 ç”¨äºè¿æ¥å…±äº«å†…å­˜ï¼Œæƒé™ä¸º 0666
* 2 _bOwner=false: ææ„æ—¶ä¸detachå…±äº«å†…å­˜
* 3 _bOwner=true: ææ„æ—¶detachå…±äº«å†…å­˜
*/
class TC_Shm
{
public:

    /**
	* @brief ???ìº¯??.
	*
	* @param bOwner  ?Ç·?Óµ?Ğ¹????Ú´?,Ä¬??Îªfalse
    */
    TC_Shm(bool bOwner = false) : _bOwner(bOwner),_shmSize(0),_shmKey(0),_bCreate(true), _pshm(NULL),_shemID(-1) {}

    /**
	* @brief ???ìº¯??.
	*
    * @param iShmSize ?????Ú´???Ğ¡
    * @param iKey     ?????Ú´?Key
    * @throws         TC_Shm_Exception
    */
    TC_Shm(size_t iShmSize, key_t iKey, bool bOwner = false);

    /**
    * @brief ?ö¹¹º???.
    */
    ~TC_Shm();

    /**
	* @brief ??Ê¼??.
	*
    * @param iShmSize   ?????Ú´???Ğ¡
    * @param iKey       ?????Ú´?Key
    * @param bOwner     ?Ç·?Óµ?Ğ¹????Ú´?
    * @throws           TC_Shm_Exception
    * @return ??
    */
    void init(size_t iShmSize, key_t iKey, bool bOwner = false);

	/**
	* @brief ?Ğ¶Ï¹????Ú´??????Í£????ÉµÄ¹????Ú´?,????Á¬???ÏµÄ¹????Ú´?
	* ?????????ÉµÄ¹????Ú´?,??Ê±???Ô¸?????Òª????Ê¼??
	*
    * @return  true,???É¹????Ú´?; false, Á¬???ÏµÄ¹????Ú´?
    */
    bool iscreate()     {return _bCreate;}

    /**
	* @brief  ??È¡?????Ú´???Ö¸??.
	*
    * @return   void* ?????Ú´?Ö¸??
    */
    void *getPointer() {return _pshm;}

    /**
	* @brief  ??È¡?????Ú´?Key.
	*
    * @return key_t* ,?????Ú´?key
    */
    key_t getkey()  {return _shmKey;}

    /**
	* @brief  ??È¡?????Ú´?ID.
	*
    * @return int ,?????Ú´?Id
    */
    int getid()     {return _shemID;}

    /**
	*  @brief  ??È¡?????Ú´???Ğ¡.
	*
    * return size_t,?????Ú´???Ğ¡
    */
    size_t size()   {return _shmSize;}

	/**
	*  @brief ?????????Ú´æ£¬?Úµ?Ç°?????Ğ½????????Ú´?
    * ?????Ú´??Úµ?Ç°????????Ğ§
    * @return int
    */
    int detach();

	/**
	 *  @brief É¾???????Ú´?.
	 *
     * ??È«É¾???????Ú´?
     */
    int del();

protected:

    /**
     * ?Ç·?Óµ?Ğ¹????Ú´?
     */
    bool            _bOwner;

    /**
    * ?????Ú´???Ğ¡
    */
    size_t          _shmSize;

    /**
    * ?????Ú´?key
    */
    key_t           _shmKey;

    /**
    * ?Ç·??????ÉµÄ¹????Ú´?
    */
    bool            _bCreate;

    /**
    * ?????Ú´?
    */
    void            *_pshm;

    /**
    * ?????Ú´?id
    */
    int             _shemID;

};

}

#endif
